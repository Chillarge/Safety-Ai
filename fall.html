<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Fall Detection System</title>
  <!-- TensorFlow.js and MoveNet model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <style>
    :root {
      /* Light theme colors */
      --bgâ€‘primary: #ffffff;
      --bgâ€‘secondary: #f8f9fa;
      --bgâ€‘card: #ffffff;
      --textâ€‘primary: #1a1a1a;
      --textâ€‘secondary: #6c757d;
      --accent: #000000;
      --accentâ€‘hover: #333333;
      --border: #e9ecef;
      --shadow: rgba(0,0,0,0.1);
      --shadowâ€‘hover: rgba(0,0,0,0.2);
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --danger-shadow: rgba(220,53,69,0.2);
    }

    [data-theme="dark"] {
      /* Dark theme overrides */
      --bgâ€‘primary: #1a1a1a;
      --bgâ€‘secondary: #2d2d2d;
      --bgâ€‘card: #2d2d2d;
      --textâ€‘primary: #ffffff;
      --textâ€‘secondary: #adb5bd;
      --accent: #ffffff;
      --accentâ€‘hover: #e9ecef;
      --border: #495057;
      --shadow: rgba(0,0,0,0.3);
      --shadowâ€‘hover: rgba(0,0,0,0.5);
      --success: #20c997;
      --warning: #ffd43b;
      --danger: #fd7e14;
      --danger-shadow: rgba(253,126,20,0.2);
    }

    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu, sans-serif;
      background: var(--bgâ€‘primary);
      color: var(--textâ€‘primary);
      transition: background 0.3s, color 0.3s;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: var(--bgâ€‘card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 10px 40px var(--shadow);
      position: relative;
      max-width: 1200px;
      width: 100%;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .title {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--textâ€‘primary);
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--textâ€‘secondary);
      font-weight: 400;
    }

    .theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bgâ€‘secondary);
      border: 1px solid var(--border);
      color: var(--textâ€‘primary);
      border-radius: 8px;
      cursor: pointer;
      width: 48px;
      height: 48px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, color 0.3s;
    }

    .theme-toggle:hover {
      background: var(--accent);
      color: var(--bgâ€‘primary);
    }

    .video-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 30px;
      border: 2px solid var(--border);
      box-shadow: 0 8px 25px var(--shadow);
    }

    #webcam, #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .loading-indicator {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 1.1rem;
      z-index: 3;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 15px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .status-container {
      background: var(--bgâ€‘secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s, color 0.3s;
    }

    .status-text {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--textâ€‘primary);
    }

    .status-monitoring {
      background: var(--bgâ€‘secondary);
      color: var(--textâ€‘primary);
    }

    .status-alarm {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      animation: pulse-alarm 1s infinite;
    }

    @keyframes pulse-alarm {
      0%, 100% {
        box-shadow: 0 0 0 0 var(--danger);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 0 10px var(--danger-shadow);
        transform: scale(1.02);
      }
    }

    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .control-button {
      padding: 16px 24px;
      font-size: 1rem;
      font-weight: 600;
      border: 2px solid var(--accent);
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      transition: background 0.3s, box-shadow 0.3s, transform 0.3s;
    }

    .primary-button {
      background: var(--accent);
      color: var(--bgâ€‘primary);
    }

    .primary-button:hover:enabled {
      background: var(--accentâ€‘hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadowâ€‘hover);
    }

    .secondary-button {
      color: var(--accent);
    }

    .secondary-button:hover:enabled {
      background: var(--accent);
      color: var(--bgâ€‘primary);
      transform: translateY(-2px);
    }

    .control-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .info-panel {
      background: var(--bgâ€‘secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .info-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .info-text {
      color: var(--textâ€‘secondary);
    }

    @media (max-width: 768px) {
      .controls { grid-template-columns: 1fr; }
      .title { font-size: 2rem; }
      .theme-toggle { width: 44px; height: 44px; top: 15px; right: 15px; }
    }

    @media (max-width: 480px) {
      .container { padding: 15px; }
      .title { font-size: 1.8rem; }
      .subtitle { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Theme toggle -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">ðŸŒ™</button>

    <!-- Header -->
    <div class="header">
      <h1 class="title">AI Fall Detection System</h1>
      <p class="subtitle">Real-time monitoring with advanced pose detection technology</p>
    </div>

    <!-- Video + Canvas -->
    <div class="video-container">
      <video id="webcam" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <div class="loading-indicator" id="loadingIndicator">
        <div class="loading-spinner"></div>
        <p>Loading AI Model & Camera...</p>
      </div>
    </div>

    <!-- Status Display -->
    <div id="statusContainer" class="status-container status-monitoring">
      <div id="statusText" class="status-text">Press "Start Detection" to begin monitoring</div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button id="startButton" class="control-button primary-button">
        Start Detection
      </button>
      <button id="stopButton" class="control-button secondary-button" disabled>
        Stop Detection
      </button>
    </div>

    <!-- Info Panel -->
    <div class="info-panel">
      <div class="info-title">How it works</div>
      <div class="info-text">
        This system uses advanced AI pose detection to monitor for potential falls in real-time...
      </div>
    </div>
  </div>

  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusContainer = document.getElementById('statusContainer');
    const statusText = document.getElementById('statusText');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const alarmSound = document.getElementById('alarmSound');
    const themeToggle = document.getElementById('themeToggle');

    let detector, detectionInterval, isDetecting = false;
    let poseHistory = [];
    let fallData = { isFalling: false, fallStartTime: null, fallDetected: false, lyingStartTime: null };

    const HISTORY_LENGTH = 32,
          FALL_THRESHOLD = 0.25,
          LYING_ASPECT_RATIO = 1.5,
          FALL_CONFIRMATION_TIME = 1500,
          STATIONARY_LYING_TIME = 3000;

    function updateTheme() {
      themeToggle.textContent = document.body.getAttribute('data-theme') === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    }

    function toggleTheme() {
      const newTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateTheme();
    }

    function initTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', saved);
      updateTheme();
    }

    async function init() {
      initTheme();
      statusText.textContent = 'Loading AI model... please wait.';
      loadingIndicator.style.display = 'flex';
      startButton.disabled = true;

      try {
        detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet, {
          modelType: poseDetection.movenet.modelType.LIGHTNING
        });
        statusText.textContent = 'AI model loaded successfully. Ready to start detection.';
        startButton.disabled = false;
      } catch (e) {
        console.error('Error loading model:', e);
        statusText.textContent = 'Error loading AI model. Please refresh the page.';
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    async function startDetection() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 }, audio: false });
        video.srcObject = stream;
        await new Promise(r => video.onloadedmetadata = r);

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        isDetecting = true;
        startButton.disabled = true;
        stopButton.disabled = false;
        loadingIndicator.style.display = 'none';

        resetFallState();
        statusText.textContent = 'Monitoring active â€“ System ready';
        statusContainer.className = 'status-container status-monitoring';

        detectionInterval = setInterval(detectPose, 33);
      } catch (e) {
        console.error('Error accessing webcam:', e);
        statusText.textContent = 'Camera access denied. Please grant permission and try again.';
        loadingIndicator.style.display = 'none';
      }
    }

    function stopDetection() {
      if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
      clearInterval(detectionInterval);
      isDetecting = false;

      startButton.disabled = false;
      stopButton.disabled = true;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      statusText.textContent = 'Detection stopped. Press Start to begin again.';
      statusContainer.className = 'status-container status-monitoring';

      alarmSound.pause();
      alarmSound.currentTime = 0;
      resetFallState();
    }

    function resetFallState() {
      fallData = { isFalling: false, fallStartTime: null, fallDetected: false, lyingStartTime: null };
      poseHistory = [];

      if (isDetecting) statusText.textContent = 'Monitoring active â€“ No issues detected';
    }

    async function detectPose() {
      if (!isDetecting || !detector) return;
      try {
        const poses = await detector.estimatePoses(video);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (poses.length > 0) {
          const keypoints = poses[0].keypoints;
          drawPose(keypoints);
          checkForFall(keypoints);
        }
      } catch (e) {
        console.error('Error during pose estimation:', e);
      }
    }

    function checkForFall(keypoints) {
      if (fallData.fallDetected) return;

      const { y_center, aspect_ratio } = getPoseMetrics(keypoints);
      if (y_center === null) return;

      poseHistory.push({ y_center, timestamp: Date.now() });
      if (poseHistory.length > HISTORY_LENGTH) poseHistory.shift();

      if (poseHistory.length > 10) {
        const startY = poseHistory[0].y_center;
        const endY = poseHistory[poseHistory.length - 1].y_center;
        const drop = (endY - startY) / canvas.height;
        if (drop > FALL_THRESHOLD) fallData.isFalling = true;
      }

      if (fallData.isFalling && aspect_ratio > LYING_ASPECT_RATIO) {
        if (!fallData.fallStartTime) fallData.fallStartTime = Date.now();
        if (Date.now() - fallData.fallStartTime >= FALL_CONFIRMATION_TIME) {
          triggerAlarm('ðŸš¨ FALL DETECTED! Emergency assistance may be needed.');
          return;
        }
      } else {
        fallData.fallStartTime = null;
      }

      if (aspect_ratio > LYING_ASPECT_RATIO) {
        if (!fallData.lyingStartTime) fallData.lyingStartTime = Date.now();
        if (Date.now() - fallData.lyingStartTime >= STATIONARY_LYING_TIME) {
          triggerAlarm('âš ï¸ PERSON MAY BE UNRESPONSIVE! Check immediately.');
        }
      } else {
        fallData.lyingStartTime = null;
      }
    }

    function getPoseMetrics(keypoints) {
      const pts = keypoints.filter(p =>
        ['left_shoulder','right_shoulder','left_hip','right_hip','left_ankle','right_ankle'].includes(p.name) && p.score > 0.3
      );
      if (pts.length < 4) return { y_center: null, aspect_ratio: 0 };

      let minY=Infinity, maxY=-Infinity, minX=Infinity, maxX=-Infinity;
      pts.forEach(p => {
        minY = Math.min(minY, p.y);
        maxY = Math.max(maxY, p.y);
        minX = Math.min(minX, p.x);
        maxX = Math.max(maxX, p.x);
      });

      const height = maxY - minY;
      const width = maxX - minX;
      return {
        y_center: (minY + maxY) / 2,
        aspect_ratio: height > 10 ? width / height : 0
      };
    }

    function triggerAlarm(msg) {
      statusText.textContent = msg;
      statusContainer.className = 'status-container status-alarm';
      alarmSound.loop = true;
      alarmSound.play().catch(e => console.log('Audio play failed:', e));
    }

    function drawPose(keypoints) {
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      const pointColor = isDark ? '#fff' : '#000';
      const adjacent = poseDetection.util.getAdjacentPairs(poseDetection.SupportedModels.MoveNet);

      keypoints.forEach(p => {
        if (p.score > 0.5) {
          ctx.beginPath();
          ctx.arc(p.x, p.y, 4, 0, 2 * Math.PI);
          ctx.fillStyle = pointColor;
          ctx.fill();
          ctx.beginPath();
          ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
          ctx.strokeStyle = pointColor;
          ctx.lineWidth = 1;
          ctx.stroke();
        }
      });

      ctx.lineWidth = 3;
      ctx.strokeStyle = '#22c55e';
      adjacent.forEach(([i,j]) => {
        const p1 = keypoints[i], p2 = keypoints[j];
        if (p1.score > 0.5 && p2.score > 0.5) {
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.stroke();
        }
      });
    }

    themeToggle.addEventListener('click', toggleTheme);
    startButton.addEventListener('click', startDetection);
    stopButton.addEventListener('click', stopDetection);
    window.addEventListener('load', init);
  </script>
</body>
</html>
